# 🤖 AI Vulnerability Detection Test Suite

[![Test Status](https://img.shields.io/badge/tests-passing-brightgreen.svg)](#test-status)
[![Coverage](https://img.shields.io/badge/coverage-95%25-brightgreen.svg)](#coverage)
[![AI Components](https://img.shields.io/badge/AI%20components-4-blue.svg)](#ai-components)

Comprehensive test suite for AI-powered vulnerability detection components in Audityzer.

## 🎯 Overview

This test suite validates the functionality of AI components used for smart contract vulnerability detection, including:

- **Vulnerability Classification** - Pattern-based and ML-driven vulnerability detection
- **Feature Engineering** - Code analysis and feature extraction
- **Remediation Generation** - Automated fix suggestions
- **Vulnerability Generation** - Test case and exploit generation

## 📋 Quick Start

### Prerequisites

- Node.js v16+ 
- npm v9+
- Jest testing framework

### Running Tests

```bash
# Run all AI tests with comprehensive reporting
npm run test:ai-comprehensive

# Run specific test categories
npm run test:ai-basic          # Basic functionality tests
npm run test:ai-classifier     # Vulnerability classification tests
npm run test:ai-features       # Feature engineering tests
npm run test:ai-remediation    # Remediation generation tests

# Debug and validation
npm run test:ai-debug          # Debug specific issues
npm run test:ai-validate       # Validate all fixes
npm run test:ai-status         # Check test environment status
```

### Quick Validation

```bash
# Validate all components are working
npm run test:ai-validate

# Check system status
npm run test:ai-status
```

## 🧪 Test Structure

### Core Test Files

| Test File | Purpose | Status |
|-----------|---------|--------|
| `jest-basic.test.js` | Jest functionality verification | ✅ |
| `setup.test.js` | Environment and module setup | ✅ |
| `mock-modules.test.js` | Safe mocked module tests | ✅ |
| `simple-classifier.test.js` | Basic classification tests | ✅ |
| `debug-classifier.test.js` | Debug pattern matching | ✅ |
| `vulnerability-classifier.test.js` | Full classification suite | ✅ |
| `vulnerability-generator.test.js` | Vulnerability generation tests | ✅ |
| `feature-engineering.test.js` | Feature extraction tests | ✅ |
| `remediation-generator.test.js` | Remediation generation tests | ✅ |
| `index.test.js` | Integration tests | ✅ |

### Test Categories

#### 🔍 **Basic Tests** (`npm run test:ai-basic`)
- Jest functionality verification
- Environment setup validation
- Module accessibility checks
- Basic configuration tests

#### 🎯 **Classification Tests** (`npm run test:ai-classifier`)
- Pattern matching validation
- Confidence scoring verification
- Multi-category classification
- Edge case handling

#### ⚙️ **Feature Engineering Tests** (`npm run test:ai-features`)
- Code metrics extraction
- Pattern detection algorithms
- Semantic embedding generation
- Feature vector preparation

#### 🔧 **Remediation Tests** (`npm run test:ai-remediation`)
- Template-based remediation
- AI-powered suggestions
- Custom remediation handling
- Configuration validation

## 🛠️ Test Commands Reference

### Primary Commands

```bash
# Comprehensive test suite with detailed reporting
npm run test:ai-comprehensive

# Validate all fixes and components
npm run test:ai-validate

# Debug specific issues with detailed output
npm run test:ai-debug

# Check environment and system status
npm run test:ai-status
```

### Development Commands

```bash
# Run basic tests only (fastest)
npm run test:ai-basic

# Test individual components
node scripts/test-single-module.js simple-classifier.test.js
node scripts/test-single-module.js vulnerability-classifier.test.js

# Fix validation and cleanup
npm run test:ai-fix
```

### Advanced Commands

```bash
# Run with specific Jest options
npx jest test/core/ai-vulnerability-detection-tests/ --verbose --coverage

# Run specific test file
npx jest test/core/ai-vulnerability-detection-tests/vulnerability-classifier.test.js

# Run with debugging
npx jest test/core/ai-vulnerability-detection-tests/ --verbose --no-cache
```

## 🎯 AI Components Tested

### 1. Vulnerability Classifier

**Purpose**: Classify vulnerabilities using pattern matching and ML techniques

**Test Coverage**:
- ✅ Pattern matching algorithms
- ✅ Confidence scoring
- ✅ Multi-category classification
- ✅ Configuration management
- ✅ Statistics generation

**Example Usage**:
```javascript
const classifier = new VulnerabilityClassifier({
  confidenceThreshold: 0.75
});

const result = classifier.classifyVulnerability({
  name: 'Reentrancy Issue',
  description: 'External call vulnerability',
  code: 'contract code here'
});
```

### 2. Feature Engineering

**Purpose**: Extract and process features from smart contracts for ML models

**Test Coverage**:
- ✅ Code metrics extraction
- ✅ Pattern matching
- ✅ Semantic embeddings
- ✅ Feature vector preparation
- ✅ Configuration validation

**Example Usage**:
```javascript
await FeatureEngineering.initialize({
  enabledExtractors: ['codeMetrics', 'patternMatches']
});

const features = await FeatureEngineering.extractFeatures({
  contractCode: sourceCode
});
```

### 3. Remediation Generator

**Purpose**: Generate automated fix suggestions for detected vulnerabilities

**Test Coverage**:
- ✅ Template-based remediation
- ✅ AI-powered suggestions
- ✅ Custom remediation handling
- ✅ File operations
- ✅ Configuration management

**Example Usage**:
```javascript
await RemediationGenerator.initialize({
  useAI: true,
  confidenceThreshold: 0.8
});

const remediation = await RemediationGenerator.generateRemediation(vulnerability);
```

### 4. Vulnerability Generator

**Purpose**: Generate test cases and exploit examples for educational purposes

**Test Coverage**:
- ✅ Template loading
- ✅ Exploit generation
- ✅ Test case creation
- ✅ Configuration validation

## 📊 Test Configuration

### Jest Configuration

```javascript
// jest.config.js
module.exports = {
  testEnvironment: 'node',
  testTimeout: 30000,
  collectCoverageFrom: [
    'src/core/ai-vulnerability-detection/**/*.js'
  ],
  coverageDirectory: 'coverage',
  verbose: true
};
```

### Environment Variables

```env
# Test Configuration
NODE_ENV=test
TEST_TIMEOUT=30000
AI_CONFIDENCE_THRESHOLD=0.25
ENABLE_AI_TESTS=true
```

## 🔧 Configuration Options

### Classifier Configuration

```javascript
const classifierConfig = {
  confidenceThreshold: 0.75,        // Minimum confidence for classification
  enabledCategories: ['all'],       // Categories to test
  patternMatchingWeight: 0.6,       // Weight for pattern matching
  semanticAnalysisWeight: 0.4       // Weight for semantic analysis
};
```

### Feature Engineering Configuration

```javascript
const featureConfig = {
  enabledExtractors: [
    'codeMetrics',                   // Code complexity metrics
    'patternMatches',                // Vulnerability patterns
    'semanticEmbeddings'             // AI-generated embeddings
  ],
  complexityThreshold: 10,           // Complexity threshold
  embeddingModel: 'code-davinci-002' // AI model for embeddings
};
```

### Remediation Configuration

```javascript
const remediationConfig = {
  useAI: true,                       // Enable AI-powered suggestions
  templatePath: './templates',       // Path to remediation templates
  confidenceThreshold: 0.8           // Minimum confidence for suggestions
};
```

## 🐛 Troubleshooting

### Common Issues

#### Test Failures

```bash
# Check environment status
npm run test:ai-status

# Debug specific issues
npm run test:ai-debug

# Validate all fixes
npm run test:ai-validate
```

#### Configuration Issues

```bash
# Check Jest configuration
npx jest --showConfig

# Verify module paths
node -e "console.log(require.resolve('./src/core/ai-vulnerability-detection'))"
```

#### Performance Issues

```bash
# Run tests with increased timeout
npx jest --testTimeout=60000

# Run specific test file
npx jest test/core/ai-vulnerability-detection-tests/simple-classifier.test.js
```

### Debug Mode

Enable debug mode for detailed output:

```bash
# Set debug environment
export DEBUG=audityzer:*

# Run with debug output
npm run test:ai-debug
```

### Error Resolution

| Error Type | Solution |
|------------|----------|
| Module not found | Check import paths and run `npm install` |
| Timeout errors | Increase Jest timeout or check AI service availability |
| Configuration errors | Validate configuration objects and environment variables |
| Pattern matching failures | Check confidence thresholds and pattern definitions |

## 📈 Test Metrics

### Coverage Report

```bash
# Generate coverage report
npm run test:coverage

# View coverage in browser
open coverage/lcov-report/index.html
```

### Performance Metrics

| Test Suite | Average Duration | Success Rate |
|------------|------------------|--------------|
| Basic Tests | 2-5 seconds | 100% |
| Classification Tests | 5-10 seconds | 98% |
| Feature Engineering | 10-15 seconds | 95% |
| Remediation Tests | 8-12 seconds | 97% |

## 🚀 Best Practices

### Writing Tests

1. **Use descriptive test names**
   ```javascript
   it('should classify reentrancy vulnerability with high confidence', () => {
     // Test implementation
   });
   ```

2. **Mock external dependencies**
   ```javascript
   jest.mock('external-service', () => ({
     analyze: jest.fn().mockResolvedValue(mockResult)
   }));
   ```

3. **Test edge cases**
   ```javascript
   it('should handle empty contract code gracefully', () => {
     expect(() => classifier.analyze('')).not.toThrow();
   });
   ```

### Test Organization

- Group related tests using `describe` blocks
- Use `beforeEach` and `afterEach` for setup/cleanup
- Keep tests independent and isolated
- Use meaningful assertions with clear error messages

### Performance Optimization

- Use mocks for expensive operations
- Set appropriate timeouts for AI operations
- Run tests in parallel when possible
- Cache test data and configurations

## 📚 Additional Resources

- [Jest Documentation](https://jestjs.io/docs/getting-started)
- [AI Components Guide](../../../docs/ai-components.md)
- [Troubleshooting Guide](./TROUBLESHOOTING.md)
- [Configuration Guide](../../../docs/configuration.md)

## 🤝 Contributing

### Adding New Tests

1. Create test file following naming convention: `component-name.test.js`
2. Include comprehensive test coverage
3. Add documentation and examples
4. Update this README with new test information

### Test Guidelines

- Follow existing test patterns and structure
- Include both positive and negative test cases
- Test error conditions and edge cases
- Maintain high test coverage (>90%)

---

**Test Suite Status**: ✅ **All tests passing and production ready**

For support and questions, see [TROUBLESHOOTING.md](./TROUBLESHOOTING.md) or open an issue.