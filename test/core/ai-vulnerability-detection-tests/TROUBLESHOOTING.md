# AI Vulnerability Detection Tests - Troubleshooting Guide

## Quick Fix Steps

### 1. Run Basic Tests First
```bash
npm run test:ai-basic
```
This runs only the basic setup tests to verify Jest and the test environment are working.

### 2. Check Test Syntax
```bash
node scripts/check-test-syntax.js
```
This checks all test files for syntax errors without running them.

### 3. Run Full Test Suite
```bash
npm run test:ai-vuln
```
This runs the complete AI vulnerability detection test suite.

## Common Issues and Solutions

### Issue: "Cannot find module" errors

**Solution 1: Mock the modules**
The `mock-modules.test.js` file provides mocked versions of all modules. This allows testing the test structure without requiring the actual implementation.

**Solution 2: Create stub modules**
If modules don't exist, create minimal stub implementations:

```javascript
// src/core/ai-vulnerability-detection/index.js
module.exports = {
  initialize: async () => ({ status: 'success' }),
  isInitialized: () => true,
  getConfig: () => ({})
};
```

### Issue: Jest configuration conflicts

**Solution**: The project uses `jest.config.js` instead of package.json configuration. Make sure there's no Jest config in package.json.

### Issue: Babel/Transform errors

**Solution**: Check `babel.config.json` has the correct Node.js preset:
```json
{
  "presets": [
    ["@babel/preset-env", {
      "targets": { "node": "current" },
      "modules": "commonjs"
    }]
  ]
}
```

### Issue: Timeout errors

**Solution**: Tests are configured with 30-second timeout for AI operations. For faster testing, disable AI features:
```javascript
const mockConfig = {
  useAI: false,
  enableCodeGeneration: false
};
```

### Issue: File system permissions

**Solution**: Tests create temporary directories. Ensure write permissions:
```bash
chmod +w test/core/ai-vulnerability-detection-tests/
```

## Test Structure Validation

### Verify Test Files Exist
```bash
ls -la test/core/ai-vulnerability-detection-tests/
```

Should show:
- `jest-basic.test.js` - Basic Jest functionality
- `setup.test.js` - Environment setup tests  
- `mock-modules.test.js` - Mocked module tests
- `index.test.js` - Main module integration tests
- `feature-engineering.test.js` - Feature extraction tests
- `remediation-generator.test.js` - Remediation generation tests
- `vulnerability-generator.test.js` - Vulnerability generation tests

### Verify Source Structure
```bash
ls -la src/core/ai-vulnerability-detection/
```

Should show the module directories and files.

## Manual Test Execution

### Run Individual Test Files
```bash
# Basic functionality
npx jest test/core/ai-vulnerability-detection-tests/jest-basic.test.js

# Setup tests
npx jest test/core/ai-vulnerability-detection-tests/setup.test.js

# Mock tests (safe to run without modules)
npx jest test/core/ai-vulnerability-detection-tests/mock-modules.test.js
```

### Run with Debug Output
```bash
npx jest test/core/ai-vulnerability-detection-tests/ --verbose --no-cache
```

### Run with Coverage
```bash
npx jest test/core/ai-vulnerability-detection-tests/ --coverage
```

## Environment Requirements

### Node.js Version
- Minimum: Node.js 16.0.0
- Recommended: Node.js 18.0.0+

### Dependencies
Required packages:
- `jest` - Testing framework
- `fs-extra` - Enhanced file system operations
- `babel-jest` - Babel transformer for Jest

### Development Dependencies
```bash
npm install --save-dev jest babel-jest @babel/core @babel/preset-env
```

## Creating Minimal Module Stubs

If the actual modules don't exist yet, create these minimal stubs:

### Feature Engineering Stub
```javascript
// src/core/ai-vulnerability-detection/model-development/feature-engineering.js
module.exports = {
  initialize: async (config) => true,
  isInitialized: () => true,
  getConfig: () => ({ enableSemanticEmbeddings: true }),
  extractFeatures: async (options) => ({
    features: { codeMetrics: {}, patternMatches: {} }
  }),
  prepareFeatureVector: (features) => ({ vector: [] }),
  getVulnerabilityPatterns: () => ({ reentrancy: [] })
};
```

### Remediation Generator Stub
```javascript
// src/core/ai-vulnerability-detection/model-development/remediation-generator.js
module.exports = {
  initialize: async (config) => ({ status: 'success' }),
  isInitialized: () => true,
  getConfig: () => ({ confidenceThreshold: 0.7 }),
  generateRemediationReport: async (vulns) => ({
    vulnerabilityCount: vulns.length,
    remediations: []
  }),
  getRemediationTemplates: () => ({ REENTRANCY: [] })
};
```

## Success Indicators

When tests are working correctly, you should see:
- ✅ All basic tests pass
- ✅ No module import errors
- ✅ Temporary directories created and cleaned up
- ✅ Mock functions called correctly
- ✅ Async operations complete within timeout

## Getting Help

If issues persist:
1. Check the Jest documentation: https://jestjs.io/docs/getting-started
2. Verify Node.js and npm versions
3. Clear node_modules and reinstall: `rm -rf node_modules && npm install`
4. Check for conflicting Jest configurations
5. Run tests in isolation to identify problematic files